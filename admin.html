<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width" />

  <title>Solo Administradores</title>

  <script type="module" src="lib/js/ejecuta.js"></script>
  <script type="module" src="lib/js/muestraError.js"></script>
  <script type="module" src="./js/const/ROL_ADMINISTRADOR.js"></script>
  <script type="module" src="./js/custom/mi-nav-admin.js"></script>
  <script type="module" src="./js/Sesion.js"></script>
  <script type="module" src="./js/custom/footer.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            clifford: '#da373d',
          }
        }
      }
    }


  </script>
</head>

<body onload="loadFiles()">
  <mi-nav id="nav"></mi-nav>
  <script src="path/to/chartjs/dist/chart.umd.js"></script>

  <main id="main" class="container w-full mx-auto">
    <p>Bienvenido, Administrador.</p>
    <button class="bg-clifford text-white text-sm font-bold rounded-lg p-2 m-2 justify-end item-end w-1/6 mx-auto"
      type="button" onclick="cerrarSesion()">
      Cerrar sesión
    </button>
  </main>
  <p class="text-center text-3xl text-white-500  dark:text-white-400 my-10 uppercase">Panel de administrador</p>
  <div class="p-4 container mx-auto ">
    <h2 class="uppercase font-bold text-center text-3xl text-white-500 dark:text-white-400 my-10"> Encuestas
      registradas
    </h2>
    <div class="p-4 border-white-200  border-dashed rounded-lg dark:border-white-700 shadow-xl my-2 ">
      <table id="tablaEncuesta">
        <thead>
          <tr>
            <th>ID</th>
            <th>Empresa</th>
            <th>Opciones</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <hr class="my-4 bg-gray-100">
  <div class="container mx-auto item-center p-20">
    <p class="text-center text-3xl text-white-500 dark:text-white-400 my-10 uppercase">Grafica de encuestas</p>
  
    <div class="flex justify-center">

    </div>
    <canvas id="miGrafico" width="250" height="100"></canvas>
  </div>
   
  <div class="p-4 container mx-auto ">
    <div class="p-4 border-white-200  border-dashed rounded-lg dark:border-white-700 shadow-xl my-2 ">
      <h2 class="uppercase font-bold text-center text-3xl text-white-500 dark:text-white-400 my-10">Usuarios Registrados
      </h2>
      <table id="tablaUsuarios" class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              ID
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Nombre
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Correo Electrónico
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Rol Actual
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actualizar Rol
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs text-center font-medium text-gray-500 uppercase tracking-wider">
              Estatus
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs text-center font-medium text-gray-500 uppercase tracking-wider">
              Acciones
            </th>

          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Los usuarios se cargarán aquí -->
        </tbody>
      </table>

    </div>
  </div>
  <div class="p-4 container mx-auto ">
    <div class="p-4 border-white-200  border-dashed rounded-lg dark:border-white-700 shadow-xl my-2 ">
      <h2 class="uppercase font-bold text-center text-3xl text-white-500 dark:text-white-400 my-10">Empresas Registradas
      </h2>
      <table id="tablaEmpresa" class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              ID
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Nombre
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Dirección
            </th>

            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Telefono
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Calificacion
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">

        </tbody>
      </table>

    </div>
  </div>

  <div class="p-4 container mx-auto ">
    <div class="p-4 border-white-200  border-dashed rounded-lg dark:border-white-700 shadow-xl my-2 ">
      <h2 class="uppercase font-bold text-center text-3xl text-white-500 dark:text-white-400 my-10">Mystery Shopper
        Registrados</h2>
      <table id="tablaMystery" class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              id
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Cuenta
            </th>
            <th scope="col"
              class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Correo electronico
            </th>

            <th </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">

        </tbody>
      </table>

    </div>
  </div>
 
  </div>
</div>
</div>
  <p>

    <a id="login" hidden href="login.html">Iniciar sesión</a>
    <a id="registro" hidden href="registro.html">Registrarse</a>



  </p>
  </div>
  <footer id="footer"></footer>


  <script>


   

    function eliminarRegistro(event, id) {
      event.preventDefault(); // Prevenir la acción predeterminada del enlace (navegación)

      if (confirm("¿Estás seguro de que deseas eliminar este registro?")) {
        const url = "srv/srvEliminarEncuesta.php"; // Ruta del servicio para eliminar el registro
        const data = { id: id }; // Datos a enviar al servicio (puede variar dependiendo de la implementación del servicio)
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Error al eliminar el registro.');
            }
            // window.location.href = window.location.href;
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
      location.reload();

    }

    function updateRol(id) {
      const rol = document.getElementById(`rol_${id}`).value;
      const url = "srv/srvCambiarRol.php"
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",

        },
        body: JSON.stringify({
          id: id,
          rol: rol
        })
      })
      location.reload();
    }
    async function loadFiles() {
      async function showEncuestas() {

        const url = "srv/srvMuestraResEnc.php";
        fetch(url, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Error al mostrar encuestas.');
            }
            return response.json();
          })
          .then(data => {
            console.log(data);
            renderGraph(data);

          })
          .catch(error => {
            console.error('Error:', error);
          });
      }

      const renderGraph = (encuestas) => {
        console.log(encuestas);
        const ctx = document.getElementById('miGrafico').getContext('2d');
        //grafica lineal 
        const miGrafico = new Chart(ctx, {
          type: 'line',
          data: {
            labels:  encuestas.map(encuesta => encuesta.totalPreguntas),
            datasets: [{
              label: 'Encuestas',
              data: encuestas.map(encuesta => encuesta.sumatoriaRespuestas),
              backgroundColor: 'rgb(128, 0, 128)',
              borderColor: 'rgb(128, 0, 128).',
              borderWidth: 2
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      };

      async function loadUsers() {
        try {
          const respuesta = await fetch("srv/srvObtenerUsuarios.php");
          const usuarios = await respuesta.json();
          const tbody = document.querySelector("#tablaUsuarios tbody");
          tbody.innerHTML = "";
          usuarios.forEach((usuario) => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                        <td>${usuario.id}</td>
                        <td>${usuario.cue}</td>
                        <td>${usuario.correo}</td>
                        <td>${usuario.rol_id ? usuario.rol_id : "No encontrado"}</td>
                      
                        <td>
                            <select name="rol" id="rol_${usuario.id}" class="rol-select">
                                <option value="">Seleccionar Rol</option>
                                <option value="Mystery Shopper">Mystery Shopper</option>
                                <option value="Analista">Analista</option>
                            </select>
                        </td>
                          <td>
                            <select name="status" id="rol_${usuario.id}" class="rol-select">
                                <option value="activo">Activa</option>
                                <option value="Inactivo">Inactivo</option>
                             
                            </select>
                        </td>

                      <td class="flex justify-around">
                       <button class="bg-green-500 text-white text-sm font-bold rounded-lg p-2 h-8 w-24" type="button" onclick="updateRol(${usuario.id})">Actualizar</button>
                   
                       <button class="bg-blue-500 text-white text-sm font-bold rounded-lg p-2 h-8 w-24" type="button" onclick="location.href='editarUsuario.html?id=${usuario.id}'">Editar</button>
                     
              
                        </td>
                    `;
            tbody.appendChild(fila);
          });
        } catch (error) {
          console.error("Error al cargar usuarios:", error);
        }

      }



      async function loadCompany() {
        try {
          const respuesta = await fetch("srv/srvConsultarEmpresas.php");
          const empresas = await respuesta.json();

          const tbodyEmpresa = document.querySelector("#tablaEmpresa tbody");
          tbodyEmpresa.innerHTML = "";
          if (empresas.length > 0) {
            empresas.forEach((empresa) => {
              let fila = document.createElement("tr");
              fila.innerHTML = `
                      <td>${empresa.id}</td>
                      <td>${empresa.nombre}</td>
                      <td>${empresa.direccion}</td>
                      <td>${empresa.telefono}</td>
                      <td class="rating">${showStars(empresa.calificacion)}</td>
                  `;
              tbodyEmpresa.appendChild(fila);
            });
          }
        } catch (error) {
          console.error('Error al cargar empresas:', error);
        }
      }

      function showStars(rating) {
        let stars = '';
        for (let i = 5; i >= 1; i--) {
          if (rating >= i) {
            stars += '<span class="fa fa-star checked"></span>';
          }
          else {
            stars += '<span class="fa fa-star"></span>';
          }
        }
        return stars;
      }
      async function loadMystery() {
        try {
          const respuesta = await fetch("srv/srvConsultarMysteryShoppers.php");
          const mysterys = await respuesta.json();
          console.log(mysterys);

          const tbodyMystery = document.querySelector("#tablaMystery tbody");
          tbodyMystery.innerHTML = "";

          if (mysterys.length > 0) {
            mysterys.forEach((mystery) => {
              let fila = document.createElement("tr");
              fila.innerHTML = `
                          <td>${mystery.id}</td>
                          <td>${mystery.cue}</td>
                          <td>${mystery.correo}</td>
                      `;
              tbodyMystery.appendChild(fila);
            });
          }
        } catch (error) {
          console.error('Error al cargar MYSTERY:', error);
        }
      }


      async function loadQuestion() {
        try {
          const respuesta = await fetch("srv/srvListaEncuesta.php");
          const encuestas = await respuesta.json();
          console.log(encuestas);
          const tbodyencuesta = document.querySelector("#tablaEncuesta tbody");
          tbodyencuesta.innerHTML = "";
          if (encuestas.length > 0) {
            encuestas.forEach((encuesta) => {
              let fila = document.createElement("tr");
              fila.innerHTML = `
                      <td>${encuesta.idEnc}</td>
                      <td>${encuesta.nombreEmpresa}</td>
                      <td><a href='FormEncuesta.html?empid=${encuesta.idEmp}'>C</a>
                          <a href="#" onclick="eliminarRegistro(event, ${encuesta.idEnc})">E</a>
                      </td>
                  `;
              tbodyencuesta.appendChild(fila);
            });
          }
        } catch (error) {
          console.error('Error al cargar encuestas:', error);
        }
      }
      await loadMystery();
      await loadUsers();
      await loadCompany();
      await loadQuestion();
      await showEncuestas();
    }


    async function cerrarSesion() {
      try {
        const respuesta = await fetch('srv/srvLogout.php');
        const json = await respuesta.json();
        localStorage.removeItem("isAutorizate");
        //localStorage.clear();
        location.href = 'index.html';
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
      }
    }
  </script>
  <script>


  </script>
</body>

</html>